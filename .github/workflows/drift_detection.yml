name: Terraform Drift Detection

on:
  schedule:
    - cron: '0 8 * * *' # Runs every day at 8am UTC
  workflow_dispatch:

permissions:
  contents: read
  issues: write

env:
  AWS_REGION: us-east-1
  TF_WORKING_DIR: lessons/day30/code

jobs:
  drift-detection:
    name: Detect Drift
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ env.TF_WORKING_DIR }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0
          terraform_wrapper: false

      - name: Verify working directory + backend file
        run: |
          pwd
          ls -la
          echo "----- backend.tf -----"
          sed -n '1,120p' backend.tf

      - name: Terraform Init
        run: |
          terraform init -input=false \
            -backend-config="bucket=tf-state-backend-dev-001" \
            -backend-config="key=demo/terraform.tfstate" \
            -backend-config="region=us-east-1" \
            -backend-config="dynamodb_table=terraform-state-locks" \
            -backend-config="encrypt=true"

      - name: Terraform Plan (Drift Detection)
        id: plan
        shell: bash
        run: |
          set +e
          terraform plan -detailed-exitcode -no-color -input=false > plan_output.txt 2>&1
          exitcode=$?
          echo "exitcode=$exitcode" >> "$GITHUB_OUTPUT"
          exit 0

      - name: Analyze Drift (Create GitHub Issue)
        if: steps.plan.outputs.exitcode == '2'
        uses: actions/github-script@v7
        env:
          PLAN_OUTPUT: ${{ env.TF_WORKING_DIR }}/plan_output.txt
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const planOutput = fs.readFileSync(process.env.PLAN_OUTPUT, 'utf8');

            const body = `### Drift Detected

            Terraform found changes that are not reflected in your code/state.

            <details>
            <summary>Show Plan</summary>

            \`\`\`terraform
            ${planOutput.slice(0, 65000)}
            \`\`\`

            </details>

            Please review and apply, or update the Terraform code.`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ Terraform Drift Detected',
              body
            });

            core.setFailed('Drift detected! Infrastructure state does not match configuration.');

      - name: Publish Drift Summary
        if: steps.plan.outputs.exitcode == '2'
        run: |
          echo "### ðŸš¨ Drift Detected" >> $GITHUB_STEP_SUMMARY
          echo "Terraform detected changes. Review the run logs or the created issue." >> $GITHUB_STEP_SUMMARY

      - name: No Drift
        if: steps.plan.outputs.exitcode == '0'
        run: |
          echo "### âœ… No Drift Detected" >> $GITHUB_STEP_SUMMARY
          echo "Infrastructure is in sync with the configuration." >> $GITHUB_STEP_SUMMARY

      - name: Terraform Plan Failure
        if: steps.plan.outputs.exitcode == '1'
        run: |
          echo "::error::Terraform plan failed. Check plan_output.txt in logs."
          cat plan_output.txt
          exit 1
